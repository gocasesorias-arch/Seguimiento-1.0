<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Seguimiento de Capacitaciones v3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f3f4f6; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: rgba(100,116,139,.6);
      border-radius: 9999px;
    }
  </style>
  <!-- React + ReactDOM + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="min-h-screen text-slate-900">

  <!-- NAV SUPERIOR (look m√°s corporativo) -->
  <header class="sticky top-0 z-30 bg-white/90 backdrop-blur border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
      <!-- Logo -->
      <div class="flex items-center gap-2">
        <div class="w-9 h-9 rounded-xl bg-orange-500 flex items-center justify-center text-white font-bold text-sm">
          SC
        </div>
        <div class="leading-tight hidden sm:block">
          <p class="text-sm font-semibold text-slate-800">
            Sistema de Seguimiento
          </p>
          <p class="text-xs text-slate-500">
            Plan de Capacitaciones 2025
          </p>
        </div>
      </div>

      <!-- Links -->
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="#panel" class="text-slate-600 hover:text-slate-900">Dashboard</a>
        <a href="#panel" class="text-slate-600 hover:text-slate-900">Gesti√≥n de hitos</a>
        <a href="#steps" class="text-slate-600 hover:text-slate-900">Flujo</a>
        <a href="#ayuda" class="text-slate-600 hover:text-slate-900">Gu√≠a</a>
      </nav>

      <!-- Perfil -->
      <div class="flex items-center gap-3">
        <div class="hidden sm:flex flex-col items-end text-xs">
          <span class="font-semibold text-slate-700">
            Guillermo Olivares
          </span>
          <span class="text-slate-400">Centro de Capacitaci√≥n</span>
        </div>
        <div class="w-9 h-9 rounded-full bg-orange-500 text-white flex items-center justify-center text-xs font-bold">
          GO
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-10">
    <!-- HERO estilo Jeton -->
    <section id="hero" class="grid lg:grid-cols-[1.4fr,1fr] gap-8 items-center">
      <div>
        <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-green-50 text-green-700 text-xs font-medium mb-4">
          <span class="w-2 h-2 rounded-full bg-green-500 inline-block"></span>
          Seguimiento en tiempo real ¬∑ Plan 2025
        </div>
        <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold tracking-tight text-slate-900">
          Un solo panel para controlar
          <span class="text-orange-500"> todas tus capacitaciones.</span>
        </h1>
        <p class="mt-4 text-sm sm:text-base text-slate-600 max-w-xl">
          Visualiza el estado de cada curso, gestiona hitos con un clic y conoce el
          avance global del plan de formaci√≥n sin perderte en planillas infinitas.
        </p>
        <div class="mt-6 flex flex-wrap items-center gap-3">
          <a href="#panel"
             class="inline-flex items-center justify-center px-5 py-2.5 rounded-lg bg-orange-500 hover:bg-orange-600 text-white text-sm font-semibold shadow-md">
            üìä Ver Dashboard
          </a>
          <a href="#panel"
             class="inline-flex items-center justify-center px-5 py-2.5 rounded-lg border border-slate-300 text-sm font-semibold text-slate-700 hover:bg-slate-50">
            ‚úÖ Gesti√≥n de Hitos
          </a>
          <div class="flex items-center gap-2 text-xs text-slate-500">
            <span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>
            Datos desde capacitaciones_data.json
          </div>
        </div>
      </div>

      <!-- Tarjeta resumen (ejemplo, se sobreescribe con datos reales) -->
      <aside class="bg-white rounded-2xl shadow-lg border border-slate-100 p-5 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Avance del plan</p>
            <p class="mt-1 text-3xl font-bold text-emerald-600" id="hero-porcentaje">
              0<span class="text-lg align-top">%</span>
            </p>
          </div>
          <div class="rounded-full bg-slate-100 px-3 py-1 text-[11px] font-medium text-slate-600">
            En ejecuci√≥n + Realizados
          </div>
        </div>
        <div class="w-full bg-slate-100 rounded-full h-2 overflow-hidden">
          <div id="hero-porcentaje-bar" class="h-2 bg-gradient-to-r from-emerald-500 to-emerald-600 w-[0%]"></div>
        </div>
        <div class="grid grid-cols-3 gap-3 text-xs">
          <div class="p-3 rounded-xl border border-slate-100 bg-slate-50">
            <p class="text-[11px] text-slate-500 mb-1">Total cursos</p>
            <p class="text-lg font-semibold text-slate-800" id="hero-total">0</p>
          </div>
          <div class="p-3 rounded-xl border border-slate-100 bg-slate-50">
            <p class="text-[11px] text-slate-500 mb-1">En ejecuci√≥n</p>
            <p class="text-lg font-semibold text-orange-500" id="hero-ejecucion">0</p>
          </div>
          <div class="p-3 rounded-xl border border-slate-100 bg-slate-50">
            <p class="text-[11px] text-slate-500 mb-1">Realizados</p>
            <p class="text-lg font-semibold text-emerald-600" id="hero-realizado">0</p>
          </div>
        </div>
        <div class="border-t border-slate-100 pt-3 text-xs text-slate-500">
          √öltima actualizaci√≥n: <span class="font-semibold text-slate-700" id="hero-update">‚Äî</span>
        </div>
      </aside>
    </section>

    <!-- BLOQUE OSCURO estilo Osmo -->
    <section id="highlights" class="rounded-3xl bg-slate-900 text-slate-100 p-6 sm:p-8">
      <div class="flex flex-col lg:flex-row gap-8 items-start">
        <div class="lg:w-1/2">
          <h2 class="text-2xl sm:text-3xl font-semibold tracking-tight">
            Un panel dise√±ado para equipos que no quieren perderse en Excel.
          </h2>
          <p class="mt-3 text-sm sm:text-base text-slate-300">
            Inspirado en plataformas modernas como Jeton y sistemas visuales como Osmo,
            este panel re√∫ne filtros claros, tarjetas legibles y un flujo visual entendible para cualquier usuario.
          </p>
          <div class="mt-5 flex flex-wrap gap-3 text-xs">
            <span class="px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-300 border border-emerald-500/40">
              Actualizaci√≥n en tiempo real
            </span>
            <span class="px-3 py-1 rounded-full bg-sky-500/10 text-sky-300 border border-sky-500/40">
              Dise√±o responsive
            </span>
            <span class="px-3 py-1 rounded-full bg-fuchsia-500/10 text-fuchsia-300 border border-fuchsia-500/40">
              Enfoque en experiencia de usuario
            </span>
          </div>
        </div>
        <div class="lg:w-1/2 grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="rounded-2xl bg-slate-800/80 border border-slate-700 p-4">
            <p class="text-xs font-semibold text-slate-400 mb-1">Filtros avanzados</p>
            <p class="text-sm font-medium">
              VP, Gerencia, A√±o, Tipo de Plan y Responsable integrados en un solo panel.
            </p>
          </div>
          <div class="rounded-2xl bg-slate-800/80 border border-slate-700 p-4">
            <p class="text-xs font-semibold text-slate-400 mb-1">Progreso real</p>
            <p class="text-sm font-medium">
              Avance calculado como <span class="text-emerald-300">En ejecuci√≥n + Realizados</span> sobre el total filtrado.
            </p>
          </div>
          <div class="rounded-2xl bg-slate-800/80 border border-slate-700 p-4">
            <p class="text-xs font-semibold text-slate-400 mb-1">Gesti√≥n de hitos</p>
            <p class="text-sm font-medium">
              Flujo de 4 hitos por estado con avance autom√°tico y estados especiales.
            </p>
          </div>
          <div class="rounded-2xl bg-slate-800/80 border border-slate-700 p-4">
            <p class="text-xs font-semibold text-slate-400 mb-1">Exportaci√≥n profesional</p>
            <p class="text-sm font-medium">
              Exporta los cursos filtrados a CSV con nombres de columnas en espa√±ol.
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- TIMELINE DE ESTADOS -->
    <section id="steps" class="space-y-6">
      <div class="flex items-center justify-between gap-4">
        <h2 class="text-xl sm:text-2xl font-semibold text-slate-900">
          Flujo de estados del ciclo de capacitaci√≥n.
        </h2>
        <p class="text-xs sm:text-sm text-slate-500 max-w-xs text-right">
          Desde el requerimiento pendiente hasta el curso realizado,
          toda la organizaci√≥n comparte el mismo lenguaje visual.
        </p>
      </div>
      <div class="bg-white rounded-2xl shadow-sm border border-slate-200 px-4 py-5 overflow-x-auto">
        <div class="flex items-center gap-6 min-w-max text-xs">
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-full border-2 border-slate-400 flex items-center justify-center font-semibold text-slate-500">01</div>
            <div><p class="font-semibold text-slate-700">Pendiente</p><p class="text-slate-400">Recepci√≥n de requerimiento</p></div>
          </div><div class="h-px bg-slate-200 flex-1"></div>
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-full border-2 border-slate-400 flex items-center justify-center font-semibold text-slate-500">02</div>
            <div><p class="font-semibold text-slate-700">Planificado</p><p class="text-slate-400">Proveedor y fechas definidas</p></div>
          </div><div class="h-px bg-slate-200 flex-1"></div>
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-full border-2 border-slate-400 flex items-center justify-center font-semibold text-slate-500">03</div>
            <div><p class="font-semibold text-slate-700">En Proceso</p><p class="text-slate-400">N√≥minas y log√≠stica</p></div>
          </div><div class="h-px bg-slate-200 flex-1"></div>
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-full border-2 border-slate-400 flex items-center justify-center font-semibold text-slate-500">04</div>
            <div><p class="font-semibold text-slate-700">Programado</p><p class="text-slate-400">Fechas confirmadas</p></div>
          </div><div class="h-px bg-slate-200 flex-1"></div>
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-full border-2 border-orange-500 bg-orange-50 flex items-center justify-center font-semibold text-orange-600">05</div>
            <div><p class="font-semibold text-orange-700">En Ejecuci√≥n</p><p class="text-slate-400">Curso en desarrollo</p></div>
          </div><div class="h-px bg-slate-200 flex-1"></div>
          <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-full border-2 border-emerald-500 bg-emerald-50 flex items-center justify-center font-semibold text-emerald-600">06</div>
            <div><p class="font-semibold text-emerald-700">Realizado</p><p class="text-slate-400">Cierre y certificaci√≥n</p></div>
          </div>
        </div>
      </div>
    </section>

    <!-- AQU√ç VA TU APP REACT -->
    <section id="panel" class="space-y-4">
      <div class="flex items-center justify-between">
        <h2 class="text-xl sm:text-2xl font-semibold text-slate-900">
          Panel de Capacitaciones
        </h2>
        <p class="text-xs sm:text-sm text-slate-500">
          Vista interactiva: filtros, hitos, estados y exportaci√≥n a CSV.
        </p>
      </div>
      <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-4 sm:p-6">
        <div id="root"></div>
      </div>
    </section>

    <!-- FOOTER -->
    <footer id="ayuda" class="py-6 text-xs text-slate-500">
      <div class="border-t border-slate-200 pt-4 flex flex-col sm:flex-row items-center justify-between gap-2">
        <p>¬© 2025 Panel de Seguimiento de Capacitaciones ¬∑ Uso interno.</p>
        <div class="flex gap-4">
          <span>v3.0</span>
          <a href="#panel" class="hover:text-slate-700">Ir al panel</a>
        </div>
      </div>
    </footer>
  </main>

  <!-- REACT APP (basada en tu seguimiento_capacitaciones.html) -->
  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    const classNames = (...xs) => xs.filter(Boolean).join(" ");

    // Iconos simples
    const CheckCircle = (props) => (
      <svg viewBox="0 0 24 24" width={props.size||20} height={props.size||20}
           className={props.className||""} fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10" />
        <path d="M9 12l2 2 4-5" />
      </svg>
    );
    const XCircle = (props) => (
      <svg viewBox="0 0 24 24" width={props.size||20} height={props.size||20}
           className={props.className||""} fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="12" cy="12" r="10" />
        <line x1="9" y1="9" x2="15" y2="15" />
        <line x1="15" y1="9" x2="9" y2="15" />
      </svg>
    );

    // Mapeo de columnas a llaves del JSON
    const COL = Object.freeze({
      id: "ID POWERBI",
      anio: "A√±o",
      estado: "Estado Actividad",
      responsable: "Usuario Responsable Capacitaci√≥n CMDIC",
      vp: "VP",
      gerencia: "Gerencia",
      tipoPlan: "Tipo de Plan",
      nombre: "Nombre Curso",
      objetivo: "Objetivo Curso",
      horas: "Horas Curso",
      otec: "OTEC Sugerido",
      modalidad: "Modalidad",
      participantesProgramados: "Total Participantes Programados",
      participantesReales: "Participaci√≥n Real",
    });

    // Flujo de estados e hitos
    const HITOS = [
      {
        estado: "Pendiente",
        nombre: "Pendiente",
        color: "bg-gray-100 border-gray-400 text-gray-700",
        subHitos: [
          "Recepci√≥n de requerimiento",
          "Revisi√≥n de informaci√≥n",
          "Confirmaci√≥n de alineamiento",
          "Autorizaci√≥n inicial"
        ]
      },
      {
        estado: "Planificado",
        nombre: "Planificado",
        color: "bg-blue-100 border-blue-400 text-blue-700",
        subHitos: [
          "Definici√≥n de proveedor",
          "Definici√≥n de fechas",
          "Validaci√≥n con l√≠deres",
          "Asignaci√≥n de presupuesto"
        ]
      },
      {
        estado: "En Proceso",
        nombre: "En Proceso",
        color: "bg-indigo-100 border-indigo-400 text-indigo-700",
        subHitos: [
          "Dise√±o de log√≠stica",
          "Revisi√≥n de n√≥mina",
          "Bloqueo de agenda",
          "Confirmaci√≥n de recursos"
        ]
      },
      {
        estado: "Programado",
        nombre: "Programado",
        color: "bg-yellow-100 border-yellow-500 text-yellow-800",
        subHitos: [
          "Invitaci√≥n enviada",
          "Confirmaci√≥n de participantes",
          "Coordinaci√≥n con OTEC",
          "Checklist previo a ejecuci√≥n"
        ]
      },
      {
        estado: "En Ejecuci√≥n",
        nombre: "En Ejecuci√≥n",
        color: "bg-orange-100 border-orange-500 text-orange-700",
        subHitos: [
          "Ejecuci√≥n en curso",
          "Control de asistencia",
          "Gesti√≥n de incidencias",
          "Cierre diario"
        ]
      },
      {
        estado: "Realizado",
        nombre: "Realizado",
        color: "bg-green-100 border-green-500 text-green-700",
        subHitos: [
          "Carga de asistencia final",
          "Encuesta de satisfacci√≥n",
          "Emisi√≥n de certificados",
          "Cierre administrativo"
        ]
      }
    ];

    const ESPECIALES = [
      { estado: "Suspendido", nombre: "Suspendido", color: "bg-red-100 border-red-500 text-red-700" },
      { estado: "Postergado", nombre: "Postergado", color: "bg-purple-100 border-purple-400 text-purple-700" }
    ];

    // Hook de carga de cursos desde capacitaciones_data.json
    function useCursos() {
      const [cursos, setCursos] = useState([]);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);

      useEffect(() => {
        fetch("capacitaciones_data.json", { cache: "no-store" })
          .then(r => {
            if (!r.ok) throw new Error("No se pudo cargar capacitaciones_data.json");
            return r.json();
          })
          .then(json => {
            if (!Array.isArray(json)) throw new Error("JSON inv√°lido: se esperaba un arreglo");
            setCursos(json);
            const now = new Date();
            const label = now.toLocaleString("es-CL", { dateStyle: "short", timeStyle: "short" });
            const span = document.getElementById("hero-update");
            if (span) span.textContent = label;
          })
          .catch(e => setError(e))
          .finally(() => setLoading(false));
      }, []);

      return { cursos, setCursos, loading, error };
    }

    // Componente de filtros
    function PanelFiltros({ filtros, setFiltros, texto, setTexto, opciones, onExport }) {
      const [open, setOpen] = useState(true);
      const activos =
        (filtros.vp !== "Todos") +
        (filtros.gerencia !== "Todas") +
        (filtros.tipoPlan !== "Todos") +
        (filtros.a√±o !== "Todos") +
        (filtros.responsable !== "Todos") +
        (texto ? 1 : 0);

      const limpiar = () => {
        setFiltros({ vp: "Todos", gerencia: "Todas", tipoPlan: "Todos", a√±o: "Todos", responsable: "Todos" });
        setTexto("");
      };

      return (
        <div className="bg-white rounded-xl border border-slate-200 shadow-sm p-4 mb-4">
          <div className="flex items-center justify-between mb-3">
            <button
              onClick={() => setOpen(o => !o)}
              className="flex items-center gap-2 text-sm font-semibold text-slate-700"
            >
              <span className="inline-flex items-center justify-center w-6 h-6 rounded-full bg-orange-500 text-white text-xs font-bold">
                {activos}
              </span>
              Filtros
            </button>
            <div className="flex items-center gap-2">
              <button
                onClick={limpiar}
                className="px-3 py-1.5 text-xs rounded-full border border-slate-300 text-slate-500 hover:bg-slate-50"
              >
                üßπ Limpiar filtros
              </button>
              <button
                onClick={onExport}
                className="px-3 py-1.5 text-xs rounded-full bg-emerald-500 text-white font-semibold hover:bg-emerald-600"
              >
                ‚¨á Exportar CSV
              </button>
            </div>
          </div>
          {open && (
            <div className="space-y-3">
              <input
                value={texto}
                onChange={e => setTexto(e.target.value)}
                placeholder="Buscar por nombre, objetivo, VP, gerencia, modalidad‚Ä¶"
                className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg focus:outline-none focus:border-orange-500"
              />
              <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3 text-xs">
                <select
                  value={filtros.vp}
                  onChange={e => setFiltros(f => ({ ...f, vp: e.target.value }))}
                  className="px-3 py-2 border border-slate-300 rounded-lg"
                >
                  {opciones.vps.map(v => <option key={v} value={v}>{v}</option>)}
                </select>
                <select
                  value={filtros.gerencia}
                  onChange={e => setFiltros(f => ({ ...f, gerencia: e.target.value }))}
                  className="px-3 py-2 border border-slate-300 rounded-lg"
                >
                  {opciones.gerencias.map(v => <option key={v} value={v}>{v}</option>)}
                </select>
                <select
                  value={filtros.tipoPlan}
                  onChange={e => setFiltros(f => ({ ...f, tipoPlan: e.target.value }))}
                  className="px-3 py-2 border border-slate-300 rounded-lg"
                >
                  {opciones.tipos.map(v => <option key={v} value={v}>{v}</option>)}
                </select>
                <select
                  value={filtros.a√±o}
                  onChange={e => setFiltros(f => ({ ...f, a√±o: e.target.value }))}
                  className="px-3 py-2 border border-slate-300 rounded-lg"
                >
                  {opciones.a√±os.map(v => <option key={v} value={v}>{v}</option>)}
                </select>
                <select
                  value={filtros.responsable}
                  onChange={e => setFiltros(f => ({ ...f, responsable: e.target.value }))}
                  className="px-3 py-2 border border-slate-300 rounded-lg"
                >
                  {opciones.responsables.map(v => <option key={v} value={v}>{v}</option>)}
                </select>
              </div>
            </div>
          )}
        </div>
      );
    }

    function ResumenTiles({ resumen }) {
      const Tile = ({ label, value, tone }) => {
        const palettes = {
          gray: ["bg-gray-50","border-gray-300","text-gray-700","text-gray-600"],
          blue: ["bg-blue-50","border-blue-300","text-blue-700","text-blue-600"],
          yellow: ["bg-yellow-50","border-yellow-300","text-yellow-700","text-yellow-600"],
          orange: ["bg-orange-50","border-orange-300","text-orange-700","text-orange-600"],
          green: ["bg-green-50","border-green-300","text-green-700","text-green-600"],
          red: ["bg-red-50","border-red-300","text-red-700","text-red-600"],
          purple:["bg-purple-50","border-purple-300","text-purple-700","text-purple-600"],
          default:["bg-slate-50","border-slate-200","text-slate-800","text-slate-600"],
        }[tone || "default"];
        return (
          <div className={classNames("text-center p-4 rounded-lg border-2", palettes[0], palettes[1])}>
            <p className={classNames("text-2xl font-bold", palettes[2])}>{value}</p>
            <p className={classNames("text-sm", palettes[3])}>{label}</p>
          </div>
        );
      };

      return (
        <div className="space-y-4">
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
            <Tile label="Total" value={resumen.total} />
            <Tile label="Pendientes" value={resumen.pendiente} tone="gray" />
            <Tile label="Planificados" value={resumen.planificado} tone="blue" />
            <Tile label="En Proceso" value={resumen.enProceso} tone="yellow" />
            <Tile label="Programado" value={resumen.programado} tone="yellow" />
            <Tile label="En ejecuci√≥n" value={resumen.ejec} tone="orange" />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <Tile label="Realizados" value={resumen.ok} tone="green" />
            <Tile label="Suspendidos" value={resumen.susp} tone="red" />
          </div>
        </div>
      );
    }

    function App() {
      const { cursos, loading, error } = useCursos();
      const [vista, setVista] = useState("dashboard");
      const [paso, setPaso] = useState(0);
      const [texto, setTexto] = useState("");
      const [filtros, setFiltros] = useState({
        vp: "Todos",
        gerencia: "Todas",
        tipoPlan: "Todos",
        a√±o: "Todos",
        responsable: "Todos"
      });
      const [progreso, setProgreso] = useState(() => {
        try { return JSON.parse(localStorage.getItem("progresoHitos_v3")) || {}; }
        catch { return {}; }
      });

      useEffect(() => {
        localStorage.setItem("progresoHitos_v3", JSON.stringify(progreso));
      }, [progreso]);

      const opciones = useMemo(() => ({
        vps: ["Todos", ...new Set(cursos.map(c => c[COL.vp]).filter(Boolean))].sort(),
        gerencias: ["Todas", ...new Set(cursos.map(c => c[COL.gerencia]).filter(Boolean))].sort(),
        tipos: ["Todos", ...new Set(cursos.map(c => c[COL.tipoPlan]).filter(Boolean))].sort(),
        a√±os: ["Todos", ...new Set(cursos.map(c => String(c[COL.anio])).filter(Boolean))].sort(),
        responsables: ["Todos", ...new Set(cursos.map(c => c[COL.responsable]).filter(Boolean))].sort(),
      }), [cursos]);

      const getId = (curso) =>
        curso[COL.id] || `${curso[COL.nombre] || "curso"}-${curso[COL.anio] || ""}`;

      const estadoBase = (curso) => curso[COL.estado] || "Pendiente";

      const estadoActual = (curso) => {
        const id = getId(curso);
        return (progreso[id] && progreso[id].estadoActual) || estadoBase(curso);
      };

      const aplicaFiltros = (c) => {
        const matchText =
          !texto ||
          [COL.nombre, COL.objetivo, COL.vp, COL.gerencia, COL.tipoPlan, COL.modalidad, COL.responsable]
            .some(k => String(c[k] || "").toLowerCase().includes(texto.toLowerCase()));
        const okVP = filtros.vp === "Todos" || c[COL.vp] === filtros.vp;
        const okG = filtros.gerencia === "Todas" || c[COL.gerencia] === filtros.gerencia;
        const okT = filtros.tipoPlan === "Todos" || c[COL.tipoPlan] === filtros.tipoPlan;
        const okA = filtros.a√±o === "Todos" || String(c[COL.anio]) === filtros.a√±o;
        const okR = filtros.responsable === "Todos" || c[COL.responsable] === filtros.responsable;
        return matchText && okVP && okG && okT && okA && okR;
      };

      const cursosFiltrados = useMemo(
        () => cursos.filter(aplicaFiltros),
        [cursos, filtros, texto]
      );

      // Resumen: % avance = (En Ejecuci√≥n + Realizado) / Total
      const resumen = useMemo(() => {
        const total = cursosFiltrados.length || 0;
        const count = (estado) =>
          cursosFiltrados.filter(c => estadoActual(c) === estado).length;
        const pendiente = count("Pendiente");
        const planificado = count("Planificado");
        const enProceso = count("En Proceso");
        const programado = count("Programado");
        const ejec = count("En Ejecuci√≥n");
        const ok = count("Realizado");
        const susp = count("Suspendido");
        const post = count("Postergado");
        const pct = total ? ((ejec + ok) / total) * 100 : 0;

        // Actualizar hero con estos datos
        const elP = document.getElementById("hero-porcentaje");
        const bar = document.getElementById("hero-porcentaje-bar");
        const tEl = document.getElementById("hero-total");
        const eEl = document.getElementById("hero-ejecucion");
        const rEl = document.getElementById("hero-realizado");
        if (elP) elP.innerHTML = `${pct.toFixed(1)}<span class="text-lg align-top">%</span>`;
        if (bar) bar.style.width = `${pct}%`;
        if (tEl) tEl.textContent = String(total);
        if (eEl) eEl.textContent = String(ejec);
        if (rEl) rEl.textContent = String(ok);

        return { total, pendiente, planificado, enProceso, programado, ejec, ok, susp, post, pct };
      }, [cursosFiltrados, progreso]);

      const cursosPaso = useMemo(() => {
        const estadoPaso = HITOS[paso].estado;
        return cursosFiltrados.filter(c => estadoActual(c) === estadoPaso);
      }, [cursosFiltrados, paso, progreso]);

      const toggleHito = (curso, indexHito) => {
        const id = getId(curso);
        const base = estadoBase(curso);
        const curr = progreso[id] || { hitos: [false, false, false, false], estadoActual: base };
        const nextHitos = [...curr.hitos];
        nextHitos[indexHito] = !nextHitos[indexHito];

        let nextEstado = curr.estadoActual || base;
        const defs = HITOS.find(h => h.estado === nextEstado);
        if (nextHitos.every(Boolean) && defs) {
          const pos = HITOS.findIndex(h => h.estado === nextEstado);
          if (pos >= 0 && pos < HITOS.length - 1) {
            nextEstado = HITOS[pos + 1].estado;
            nextHitos.fill(false);
          }
        }

        setProgreso(prev => ({
          ...prev,
          [id]: { hitos: nextHitos, estadoActual: nextEstado }
        }));
      };

      const setEstadoEspecial = (curso, estado) => {
        const id = getId(curso);
        setProgreso(prev => ({
          ...prev,
          [id]: { hitos: [false, false, false, false], estadoActual: estado }
        }));
      };

      const exportCSV = () => {
        const head = [
          "A√±o","Estado","Responsable","VP","Gerencia",
          "Tipo de Plan","Nombre Curso","Objetivo Curso",
          "Horas","OTEC","Modalidad","Participantes"
        ];
        const rows = cursosFiltrados.map(c => {
          const estado = estadoActual(c);
          const part = c[COL.participantesProgramados] ?? c[COL.participantesReales] ?? 0;
          return [
            c[COL.anio],
            estado,
            c[COL.responsable],
            c[COL.vp],
            c[COL.gerencia],
            c[COL.tipoPlan],
            c[COL.nombre],
            (c[COL.objetivo] || "").replace(/\n/g, " "),
            c[COL.horas],
            c[COL.otec],
            c[COL.modalidad],
            part
          ];
        });
        const csv = [head, ...rows]
          .map(r => r.map(x => `"${(x ?? "").toString().replace(/"/g, '""')}"`).join(","))
          .join("\n");
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "capacitaciones_filtrado.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      };

      if (loading) {
        return (
          <div className="min-h-[200px] flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500 mx-auto mb-3"></div>
              <p className="text-sm text-slate-700">Cargando datos...</p>
            </div>
          </div>
        );
      }
      if (error) {
        return (
          <div className="bg-red-50 border border-red-200 text-red-700 p-4 rounded-xl text-sm">
            <p className="font-semibold mb-1">Error al cargar datos</p>
            <p className="mb-1">{String(error)}</p>
            <p>Aseg√∫rate de que <code>capacitaciones_data.json</code> est√© en la misma carpeta.</p>
          </div>
        );
      }

      const pasoInfo = HITOS[paso];

      return (
        <div className="space-y-4">
          {/* Tabs Dashboard / Gesti√≥n */}
          <div className="flex items-center justify-between flex-wrap gap-2">
            <div className="flex items-center gap-2">
              <button
                onClick={() => setVista("dashboard")}
                className={classNames(
                  "px-4 py-2 rounded-full text-sm font-semibold border",
                  vista === "dashboard"
                    ? "bg-orange-500 text-white border-orange-500 shadow-sm"
                    : "bg-white text-slate-600 border-slate-300 hover:bg-slate-50"
                )}
              >
                üìä Dashboard
              </button>
              <button
                onClick={() => setVista("gestion")}
                className={classNames(
                  "px-4 py-2 rounded-full text-sm font-semibold border",
                  vista === "gestion"
                    ? "bg-orange-500 text-white border-orange-500 shadow-sm"
                    : "bg-white text-slate-600 border-slate-300 hover:bg-slate-50"
                )}
              >
                ‚úÖ Gesti√≥n de Hitos
              </button>
            </div>
          </div>

          <PanelFiltros
            filtros={filtros}
            setFiltros={setFiltros}
            texto={texto}
            setTexto={setTexto}
            opciones={opciones}
            onExport={exportCSV}
          />

          {vista === "dashboard" && (
            <>
              {/* Stepper de estados */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                <h3 className="text-sm font-semibold text-slate-700 mb-3">
                  Progreso por estado
                </h3>
                <div className="flex items-center justify-between gap-2 overflow-x-auto scrollbar-thin">
                  {HITOS.map((h, idx) => {
                    const qty = cursosFiltrados.filter(c => estadoActual(c) === h.estado).length;
                    return (
                      <div key={h.estado} className="flex items-center flex-1 min-w-[110px]">
                        <button
                          onClick={() => setPaso(idx)}
                          className={classNames(
                            "flex flex-col items-center flex-1 transition-transform",
                            idx === paso ? "scale-105" : "opacity-60 hover:opacity-100"
                          )}
                        >
                          <div className={classNames(
                            "w-10 h-10 rounded-full border-4 flex items-center justify-center text-xs font-bold",
                            idx === paso
                              ? h.color
                              : idx < paso
                                ? "bg-green-100 border-green-400 text-green-700"
                                : "bg-gray-100 border-gray-300 text-gray-400"
                          )}>
                            {idx + 1}
                          </div>
                          <span className={classNames(
                            "mt-1 text-[11px] font-medium text-center",
                            idx === paso ? "text-slate-800" : "text-slate-500"
                          )}>
                            {h.nombre}
                          </span>
                          <span className={classNames(
                            "text-[11px] font-bold",
                            idx === paso ? "text-orange-600" : "text-slate-400"
                          )}>
                            {qty}
                          </span>
                        </button>
                        {idx < HITOS.length - 1 && (
                          <div className={classNames(
                            "flex-1 h-1 mx-1 rounded",
                            idx < paso ? "bg-green-400" : "bg-gray-200"
                          )} />
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>

              {/* Lista de cursos del estado actual */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 space-y-3">
                <div className="flex items-center justify-between">
                  <h3 className="text-sm font-semibold text-slate-700">
                    Cursos en estado: {pasoInfo.nombre}
                  </h3>
                  <span className="px-3 py-1 rounded-full bg-slate-100 text-xs font-semibold text-slate-700">
                    {cursosPaso.length} curso{cursosPaso.length !== 1 ? "s" : ""}
                  </span>
                </div>
                {cursosPaso.length === 0 ? (
                  <div className="py-8 text-center text-sm text-slate-500">
                    No hay cursos que cumplan los filtros.
                  </div>
                ) : (
                  <div className="space-y-3 max-h-96 overflow-y-auto scrollbar-thin">
                    {cursosPaso.map((curso, i) => {
                      const estado = estadoActual(curso);
                      const participantes =
                        curso[COL.participantesProgramados] ??
                        curso[COL.participantesReales] ??
                        0;
                      return (
                        <div
                          key={getId(curso) + i}
                          className="p-4 border border-slate-200 rounded-lg hover:border-orange-400 hover:shadow-sm transition-all"
                        >
                          <h4 className="font-semibold text-slate-800 mb-1">
                            {curso[COL.nombre] || "Sin nombre"}
                          </h4>
                          <p className="text-xs text-slate-500 mb-2 line-clamp-2">
                            {curso[COL.objetivo] || "Sin descripci√≥n"}
                          </p>
                          <div className="flex flex-wrap gap-1.5 text-[11px]">
                            <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                              {curso[COL.vp] || "Sin VP"}
                            </span>
                            <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                              {curso[COL.gerencia] || "Sin gerencia"}
                            </span>
                            <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                              {curso[COL.tipoPlan] || "Sin tipo"}
                            </span>
                            <span className="px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 border border-slate-200">
                              {curso[COL.modalidad] || "Sin modalidad"}
                            </span>
                            <span className="px-2 py-0.5 rounded-full bg-green-50 text-green-700 border border-green-200">
                              {curso[COL.horas] || 0} horas
                            </span>
                            <span className="px-2 py-0.5 rounded-full bg-orange-50 text-orange-700 border border-orange-200">
                              {participantes} participantes
                            </span>
                            <span className="px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">
                              Estado: {estado}
                            </span>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>

              {/* Resumen general */}
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                <h3 className="text-sm font-semibold text-slate-700 mb-3">
                  Resumen general (filtros aplicados)
                </h3>
                <ResumenTiles resumen={resumen} />
                <div className="mt-4 p-3 rounded-lg bg-gradient-to-r from-blue-50 to-green-50 border border-blue-100 flex items-center justify-between">
                  <div>
                    <p className="text-xs font-semibold text-slate-700">
                      Avance del plan (En ejecuci√≥n + Realizados)
                    </p>
                    <p className="text-[11px] text-slate-500">
                      Sobre el total de cursos que cumplen los filtros actuales.
                    </p>
                  </div>
                  <div className="text-2xl font-bold text-emerald-600">
                    {resumen.pct.toFixed(1)}%
                  </div>
                </div>
              </div>
            </>
          )}

          {vista === "gestion" && (
            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
              <h3 className="text-sm font-semibold text-slate-700 mb-3">
                Gesti√≥n de hitos por curso
              </h3>
              {cursosFiltrados.length === 0 ? (
                <div className="py-8 text-center text-sm text-slate-500">
                  No hay cursos que cumplan los filtros.
                </div>
              ) : (
                <div className="space-y-3 max-h-[65vh] overflow-y-auto scrollbar-thin pr-1">
                  {cursosFiltrados.map((curso) => {
                    const id = getId(curso);
                    const prog = progreso[id] || { hitos: [false,false,false,false], estadoActual: estadoBase(curso) };
                    const estado = estadoActual(curso);
                    const def = HITOS.find(h => h.estado === estado) || HITOS[0];
                    const hitos = def.subHitos;
                    const completados = prog.hitos.filter(Boolean).length;
                    const pct = (completados / hitos.length) * 100;
                    const participantes =
                      curso[COL.participantesProgramados] ??
                      curso[COL.participantesReales] ??
                      0;

                    return (
                      <div
                        key={id}
                        className="border border-slate-200 rounded-lg overflow-hidden"
                      >
                        {/* Header */}
                        <div className="p-3 bg-slate-50 flex items-center justify-between gap-3">
                          <div className="flex-1">
                            <div className="flex items-center gap-2">
                              <p className="font-semibold text-sm text-slate-800">
                                {curso[COL.nombre]}
                              </p>
                              <span className="px-2 py-0.5 text-[10px] rounded-full bg-slate-100 text-slate-600 border border-slate-200">
                                {curso[COL.vp]} ¬∑ {curso[COL.gerencia]}
                              </span>
                            </div>
                            <p className="text-[11px] text-slate-500 mt-1 line-clamp-2">
                              {curso[COL.objetivo]}
                            </p>
                          </div>
                          <div className="text-right text-[11px]">
                            <div className="mb-1">
                              <span className="px-2 py-0.5 rounded-full bg-white border text-[10px] font-semibold">
                                Estado: {estado}
                              </span>
                            </div>
                            <div className="flex items-center gap-2 justify-end">
                              <div className="text-center">
                                <div className="text-lg font-bold text-blue-600">
                                  {completados}/{hitos.length}
                                </div>
                                <div className="text-[10px] text-slate-500">hitos</div>
                              </div>
                              <div className="text-xs text-slate-500">
                                {curso[COL.horas] || 0} h ¬∑ {participantes} part.
                              </div>
                            </div>
                          </div>
                        </div>

                        {/* Barra progreso */}
                        <div className="px-3 pt-2">
                          <div className="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div
                              className="bg-gradient-to-r from-orange-500 to-orange-600 h-2"
                              style={{ width: `${pct}%` }}
                            />
                          </div>
                        </div>

                        {/* Hitos */}
                        <div className="p-3 grid sm:grid-cols-2 gap-2 text-xs">
                          {hitos.map((hito, indexHito) => (
                            <button
                              key={indexHito}
                              onClick={() => toggleHito(curso, indexHito)}
                              className={classNames(
                                "flex items-center gap-2 px-2 py-2 text-left rounded-lg border transition-all",
                                prog.hitos[indexHito]
                                  ? "bg-emerald-50 border-emerald-400"
                                  : "bg-white border-slate-200 hover:border-orange-300"
                              )}
                            >
                              <div
                                className={classNames(
                                  "w-5 h-5 rounded-full flex items-center justify-center border",
                                  prog.hitos[indexHito]
                                    ? "bg-emerald-500 border-emerald-500 text-white"
                                    : "bg-white border-slate-400 text-slate-400"
                                )}
                              >
                                {prog.hitos[indexHito] && <CheckCircle size={14} />}
                              </div>
                              <div>
                                <div className="text-[10px] font-semibold text-slate-500">
                                  Hito {indexHito + 1}
                                </div>
                                <div className="text-[11px] text-slate-700">
                                  {hito}
                                </div>
                              </div>
                            </button>
                          ))}
                        </div>

                        {/* Botones especiales */}
                        <div className="px-3 pb-3 flex flex-col sm:flex-row gap-2 border-t border-slate-200 pt-3">
                          <button
                            onClick={() => setEstadoEspecial(curso, "Suspendido")}
                            className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-red-50 text-red-700 border border-red-200 rounded-lg text-xs font-semibold hover:bg-red-100"
                          >
                            <XCircle size={16} />
                            Suspender
                          </button>
                          <button
                            onClick={() => setEstadoEspecial(curso, "Postergado")}
                            className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-purple-50 text-purple-700 border border-purple-200 rounded-lg text-xs font-semibold hover:bg-purple-100"
                          >
                            ‚è± Postergar
                          </button>
                          <button
                            onClick={() => setEstadoEspecial(curso, estadoBase(curso))}
                            className="flex-1 flex items-center justify-center gap-2 px-3 py-2 bg-slate-50 text-slate-700 border border-slate-200 rounded-lg text-xs font-semibold hover:bg-slate-100"
                          >
                            ‚Ü© Volver a estado base
                          </button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
